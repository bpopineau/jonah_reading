<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spell & Learn Adventure</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM for the application logic -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // =========================
        // All code is now inlined for browser compatibility. No import/export statements.
        // =========================

        // =========================
        // TYPES & ENUMS
        // =========================
        const GamePhase = {
            WELCOME: 'WELCOME',
            PRESENTING_WORD: 'PRESENTING_WORD',
            LISTENING: 'LISTENING',
            PROCESSING_SPEECH: 'PROCESSING_SPEECH',
            DISPLAYING_FEEDBACK: 'DISPLAYING_FEEDBACK',
            ALL_WORDS_COMPLETED: 'ALL_WORDS_COMPLETED',
        };
        const InputMethod = {
            TYPE: 'type',
        };

        // =========================
        // ICON COMPONENTS (SVG)
        // =========================
        const SpeakerWaveIcon = ({ className = "w-6 h-6" }) => (
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
            </svg>
        );
        const SparklesIcon = ({ className = "w-6 h-6" }) => (
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L1.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.25 7.5l.813 2.846a4.5 4.5 0 012.087 2.087L22.75 12l-1.598.813a4.5 4.5 0 01-2.087 2.087L18.25 16.5l-.813-2.846a4.5 4.5 0 01-2.087-2.087L13.75 12l1.598-.813a4.5 4.5 0 012.087-2.087L18.25 7.5z" />
            </svg>
        );
        const CheckCircleIcon = ({ className = "w-6 h-6" }) => (
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const XCircleIcon = ({ className = "w-6 h-6" }) => (
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const PlayIcon = ({ className = "w-6 h-6" }) => (
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
            </svg>
        );
        const ArrowPathIcon = ({ className = "w-6 h-6" }) => (
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
        );
        const StarIcon = ({ className = "w-6 h-6" }) => (
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                <path fillRule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354l-4.557 2.873c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.007z" clipRule="evenodd" />
            </svg>
        );
        const GiftIcon = ({ className = "w-6 h-6" }) => (
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0zM12 12V9.75M12 12h2.25m-2.25 0l-1.5-1.5M12 12l1.5 1.5m0 0l-1.5 1.5m1.5-1.5H9.75m2.25 0V9.75" />
            </svg>
        );
        const LoaderIcon = ({ className = "w-8 h-8 animate-spin text-sky-500" }) => (
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" className={className}>
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );
        const KeyboardIcon = ({ className = "w-6 h-6" }) => (
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
        );
        const EyeIcon = ({ className = "w-6 h-6" }) => (
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        // =========================
        // COMPANION/AVATAR COMPONENTS (IMPROVED ART)
        // =========================
        const QuillCompanion = ({ className }) => {
            return (
                <g className={className} aria-label="Friendly quill companion">
                    {/* Body with gradient */}
                    <defs>
                        <radialGradient id="quillBodyGradient" cx="50%" cy="50%" r="70%">
                            <stop offset="0%" stopColor="#FFF8DC" />
                            <stop offset="100%" stopColor="#FFD700" />
                        </radialGradient>
                        <linearGradient id="quillWingGradient" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0%" stopColor="#FFF8DC" />
                            <stop offset="100%" stopColor="#FFA500" />
                        </linearGradient>
                    </defs>
                    <ellipse cx="20" cy="20" rx="15" ry="12" fill="url(#quillBodyGradient)" stroke="#DAA520" strokeWidth="1" />
                    {/* Eyes with highlight */}
                    <circle cx="15" cy="18" r="3" fill="white" />
                    <circle cx="14" cy="18.5" r="1.5" fill="#2C3E50" />
                    <circle cx="13.5" cy="18" r="0.5" fill="#fff" opacity="0.7" />
                    <circle cx="25" cy="18" r="3" fill="white" />
                    <circle cx="24" cy="18.5" r="1.5" fill="#2C3E50" />
                    <circle cx="23.5" cy="18" r="0.5" fill="#fff" opacity="0.7" />
                    {/* Cheeks with soft pink */}
                    <ellipse cx="11" cy="23" rx="3" ry="1.5" fill="#FFB6C1" opacity="0.7" />
                    <ellipse cx="29" cy="23" rx="3" ry="1.5" fill="#FFB6C1" opacity="0.7" />
                    {/* Wings with gradient */}
                    <path d="M5 15 Q12 8 18 15 C15 18 10 18 5 15 Z" fill="url(#quillWingGradient)" stroke="#FFA500" strokeWidth="0.7" />
                    <path d="M22 15 Q28 8 35 15 C30 18 25 18 22 15 Z" fill="url(#quillWingGradient)" stroke="#FFA500" strokeWidth="0.7" />
                    {/* Smile with shadow */}
                    <path d="M18 24 Q20 26 22 24" stroke="#A52A2A" strokeWidth="1" fill="none" filter="url(#shadow)" />
                    {/* Feather on head */}
                    <path d="M20 8 Q22 4 25 6 Q23 8 20 8 Z" fill="#FFA500" stroke="#DAA520" strokeWidth="0.5" />
                </g>
            );
        };
        const PikachuCompanion = ({ className }) => {
            return (
                <g className={className} transform="scale(1.2)" aria-label="Pikachu companion">
                    <defs>
                        <radialGradient id="pikachuBodyGradient" cx="50%" cy="50%" r="70%">
                            <stop offset="0%" stopColor="#FFFDE4" />
                            <stop offset="100%" stopColor="#F7D02C" />
                        </radialGradient>
                    </defs>
                    {/* Body with gradient */}
                    <ellipse cx="35" cy="35" rx="15" ry="18" fill="url(#pikachuBodyGradient)" stroke="#E2B400" strokeWidth="1" />
                    {/* Ears with detail */}
                    <path d="M 15,15 L 10,5 L 20,12 Z" fill="#F7D02C" stroke="#000" strokeWidth="1" />
                    <ellipse cx="11" cy="4" rx="2.5" ry="1.2" fill="#222" opacity="0.7" />
                    <path d="M 10,5 L 12,2 L 15,5 Z" fill="#000" />
                    <path d="M 55,15 L 60,5 L 50,12 Z" fill="#F7D02C" stroke="#000" strokeWidth="1" />
                    <ellipse cx="59" cy="4" rx="2.5" ry="1.2" fill="#222" opacity="0.7" />
                    <path d="M 60,5 L 58,2 L 55,5 Z" fill="#000" />
                    {/* Eyes with highlight */}
                    <ellipse cx="28" cy="22" rx="3" ry="3.2" fill="#222" />
                    <ellipse cx="42" cy="22" rx="3" ry="3.2" fill="#222" />
                    <ellipse cx="29" cy="21" rx="1" ry="1.2" fill="#fff" opacity="0.8" />
                    <ellipse cx="43" cy="21" rx="1" ry="1.2" fill="#fff" opacity="0.8" />
                    {/* Cheeks with soft shadow */}
                    <ellipse cx="22" cy="28" rx="5" ry="3.5" fill="#F77C7C" opacity="0.8" />
                    <ellipse cx="48" cy="28" rx="5" ry="3.5" fill="#F77C7C" opacity="0.8" />
                    {/* Mouth with smile */}
                    <path d="M 32,30 Q 35,33 38,30" stroke="#A52A2A" strokeWidth="1.2" fill="none" />
                </g>
            );
        };
        const Avatar = ({ className = "w-24 h-24", companionType = null }) => {
            return (
                <svg
                    viewBox="0 0 130 120"
                    className={className}
                    xmlns="http://www.w3.org/2000/svg"
                    aria-label={`Player avatar ${companionType ? 'with ' + companionType + ' companion' : ''}`}
                    role="img"
                >
                    <defs>
                        <radialGradient id="avatarSkinGradient" cx="50%" cy="40%" r="70%">
                            <stop offset="0%" stopColor="#FFF3E0" />
                            <stop offset="100%" stopColor="#FDE0C5" />
                        </radialGradient>
                        <linearGradient id="avatarShirtGradient" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stopColor="#4FC3F7" />
                            <stop offset="100%" stopColor="#1976D2" />
                        </linearGradient>
                        <radialGradient id="avatarFaceShadow" cx="50%" cy="60%" r="60%">
                            <stop offset="0%" stopColor="#000" stopOpacity="0.08" />
                            <stop offset="100%" stopColor="#000" stopOpacity="0" />
                        </radialGradient>
                    </defs>
                    {/* Head with gradient and shadow */}
                    <circle cx="50" cy="35" r="20" fill="url(#avatarSkinGradient)" />
                    <ellipse cx="50" cy="40" rx="16" ry="10" fill="url(#avatarFaceShadow)" />
                    {/* Hair with more detail */}
                    <path d="M30 30 Q50 10 70 30 Q75 40 65 45 L35 45 Q25 40 30 30 Z" fill="#4A3123" stroke="#2C1B10" strokeWidth="1" />
                    {/* Eyes with highlight */}
                    <ellipse cx="42" cy="35" rx="2.7" ry="2.5" fill="#2C3E50" />
                    <ellipse cx="58" cy="35" rx="2.7" ry="2.5" fill="#2C3E50" />
                    <ellipse cx="41.5" cy="34.5" rx="0.7" ry="0.7" fill="#fff" opacity="0.7" />
                    <ellipse cx="57.5" cy="34.5" rx="0.7" ry="0.7" fill="#fff" opacity="0.7" />
                    {/* Smile with shadow */}
                    <path d="M45 45 Q50 50 55 45" stroke="#A0522D" strokeWidth="1.5" fill="none" />
                    {/* Shirt with gradient */}
                    <path d="M30 55 L30 80 Q30 85 35 85 L65 85 Q70 85 70 80 L70 55 Z" fill="url(#avatarShirtGradient)" />
                    <rect x="20" y="55" width="10" height="15" rx="2" ry="2" fill="#1976D2" />
                    <rect x="70" y="55" width="10" height="15" rx="2" ry="2" fill="#1976D2" />
                    {/* Chin shadow */}
                    <ellipse cx="50" cy="52" rx="8" ry="2.5" fill="#E0C9AC" opacity="0.5" />
                    {/* Blush */}
                    <ellipse cx="40" cy="42" rx="2.2" ry="1.1" fill="#FFB6B6" opacity="0.5" />
                    <ellipse cx="60" cy="42" rx="2.2" ry="1.1" fill="#FFB6B6" opacity="0.5" />
                    {/* Arms with highlight */}
                    <rect x="20" y="70" width="10" height="8" rx="2" ry="2" fill="#FDE0C5" stroke="#E0C9AC" strokeWidth="0.5" />
                    <rect x="70" y="70" width="10" height="8" rx="2" ry="2" fill="#FDE0C5" stroke="#E0C9AC" strokeWidth="0.5" />
                    {/* Hands */}
                    <ellipse cx="25" cy="78" rx="2" ry="1.2" fill="#FDE0C5" />
                    <ellipse cx="75" cy="78" rx="2" ry="1.2" fill="#FDE0C5" />
                    {/* Neck shadow */}
                    <ellipse cx="50" cy="55" rx="3" ry="1" fill="#E0C9AC" opacity="0.4" />
                    {/* Companion if unlocked */}
                    {companionType && (
                        <g id="companion-wrapper" transform="translate(85, 30) scale(0.9)">
                            {companionType === 'quill' && <QuillCompanion />}
                            {companionType === 'pikachu' && <PikachuCompanion />}
                        </g>
                    )}
                </svg>
            );
        };

        // =========================
        // GAME CONSTANTS
        // =========================
        const WORD_LIST = [
            { id: 'w1', text: 'CAT' }, { id: 'w2', text: 'DOG' }, { id: 'w3', text: 'SUN' },
            { id: 'w4', text: 'RUN' }, { id: 'w5', text: 'BIG' }, { id: 'w6', text: 'PIG' },
            { id: 'w7', text: 'TOP' }, { id: 'w8', text: 'HOT' }, { id: 'w9', text: 'BED' },
            { id: 'w10', text: 'YES' }, { id: 'w11', text: 'TREE' }, { id: 'w12', text: 'BOOK' },
            { id: 'w13', text: 'STAR' }, { id: 'w14', text: 'MOON' }, { id: 'w15', text: 'FISH' },
        ];
        const XP_PER_CORRECT_WORD = 10;
        const REWARDS = [
            { xpThreshold: 30, name: 'Super Speller Sticker', description: 'You earned a cool sticker!', type: 'sticker' },
            { xpThreshold: 70, name: 'Bronze Star Badge', description: 'Wow! A bronze star for your collection!', type: 'badge' },
            { xpThreshold: 120, name: 'Pikachu Buddy', description: 'Awesome! Pikachu will join your adventures!', type: 'companion', companion: 'pikachu' },
            { xpThreshold: 150, name: 'Golden Quill Companion (virtual)', description: 'Amazing! A Golden Quill friend will join your adventures!', type: 'companion', companion: 'quill' }
        ];

        // =========================
        // SPELLING ANALYSIS (NO AI)
        // =========================
        async function analyzeSpellingAttempt(targetWord, attempt) {
            console.warn("Using fallback logic for spelling analysis. Add API Key for AI feedback.");
            const normalizedTarget = targetWord.toLowerCase().replace(/[^a-z0-9]/gi, '');
            const normalizedAttempt = attempt.toLowerCase().replace(/[^a-z0-9]/gi, '');
            if (normalizedTarget === normalizedAttempt) {
                return { isCorrect: true, message: `Great job! You spelled "${targetWord}" correctly!`, attemptedWord: attempt };
            } else {
                return { isCorrect: false, message: `Almost! The word was "${targetWord}". You said "${attempt}". Try again!`, attemptedWord: attempt };
            }
        }

        // =========================
        // MAIN APP COMPONENT
        // =========================
        // The main React component for the game
        const App = () => {
            // --- STATE HOOKS ---
            const [gamePhase, setGamePhase] = React.useState(GamePhase.WELCOME);
            const [currentInputMethod, setCurrentInputMethod] = React.useState(InputMethod.TYPE);
            const [currentWordIndex, setCurrentWordIndex] = React.useState(0);
            const [currentWord, setCurrentWord] = React.useState(null);
            const [userProgress, setUserProgress] = React.useState({
                xp: 0,
                correctlySpelledWords: [],
                unlockedRewards: [],
                companionType: 'pikachu', // Pikachu is the buddy from the start!
                currentWordIndex: 0,
            });
            const [isProcessing, setIsProcessing] = React.useState(false);
            const [lastFeedback, setLastFeedback] = React.useState(null);
            const [lastUnlockedReward, setLastUnlockedReward] = React.useState(null);
            const [typedAttempt, setTypedAttempt] = React.useState("");
            const [isCurrentWordRevealed, setIsCurrentWordRevealed] = React.useState(false);

            // --- EFFECT: Load progress and setup speech recognition on mount ---
            React.useEffect(() => {
                const savedProgressRaw = localStorage.getItem('spellAndLearnProgress');
                if (savedProgressRaw) {
                    const savedProgress = JSON.parse(savedProgressRaw);
                    // For the test, we override the saved companion with Pikachu
                    setUserProgress({
                        ...savedProgress,
                        companionType: 'pikachu',
                    });
                    const idx = savedProgress.currentWordIndex || 0;
                    setCurrentWordIndex(idx);
                    if (savedProgress.correctlySpelledWords && savedProgress.correctlySpelledWords.length >= WORD_LIST.length) {
                        setGamePhase(GamePhase.ALL_WORDS_COMPLETED);
                    } else if (idx > 0 || savedProgress.xp > 0) {
                        setTimeout(() => startNextWord(), 100);
                    }
                }

                // speech recognition removed
            }, []);

            // --- EFFECT: Save progress and unlock rewards when XP changes ---
            React.useEffect(() => {
                localStorage.setItem('spellAndLearnProgress', JSON.stringify(userProgress));
                const newRewards = REWARDS.filter(
                    (reward) => userProgress.xp >= reward.xpThreshold && !userProgress.unlockedRewards.includes(reward.name)
                );
                if (newRewards.length > 0) {
                    const latestNewReward = newRewards[newRewards.length - 1];
                    let newCompanionType = userProgress.companionType;
                    if (latestNewReward.type === 'companion') {
                        newCompanionType = latestNewReward.companion;
                    }
                    setUserProgress(prev => ({
                        ...prev,
                        unlockedRewards: [...prev.unlockedRewards, latestNewReward.name],
                        companionType: newCompanionType,
                    }));
                    setLastUnlockedReward(latestNewReward);
                }
            }, [userProgress]);

            // --- SPEECH SYNTHESIS (for feedback and word reading) ---
            const speakText = React.useCallback((text, onEndCallback) => {
                if (!('speechSynthesis' in window)) {
                    console.warn("Speech synthesis not supported.");
                    if (onEndCallback) onEndCallback();
                    return;
                }
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1.2;
                if (onEndCallback) utterance.onend = onEndCallback;
                speechSynthesis.speak(utterance);
            }, []);

            // --- Start next word logic ---
            const startNextWord = React.useCallback(() => {
                setLastFeedback(null);
                setLastUnlockedReward(null);
                setTypedAttempt("");
                setIsCurrentWordRevealed(false);

                if (currentWordIndex >= WORD_LIST.length) {
                    setGamePhase(GamePhase.ALL_WORDS_COMPLETED);
                    speakText("Wow, you've spelled all the words! You're a spelling superstar!");
                    setCurrentWordIndex(0);
                    setUserProgress(prev => ({ ...prev, currentWordIndex: 0 }));
                    return;
                }
                const word = WORD_LIST[currentWordIndex];
                setCurrentWord(word);
                setGamePhase(GamePhase.PRESENTING_WORD);
                speakText(`Let's spell the word: ${word.text}. Listen carefully... ${word.text}.`, () => {
                    setGamePhase(GamePhase.LISTENING);
                });
            }, [currentWordIndex, speakText]);

            // --- Start game handler ---
            const handleStartGame = () => {
                setCurrentWordIndex(0);
                const initialProgress = { xp: 0, correctlySpelledWords: [], unlockedRewards: [], companionType: 'pikachu', currentWordIndex: 0 };
                setUserProgress(initialProgress);
                localStorage.setItem('spellAndLearnProgress', JSON.stringify(initialProgress));
                setLastUnlockedReward(null);
                startNextWord();
            };

            // --- Change input method handler ---
            const handleChangeInputMethod = (method) => {
                setCurrentInputMethod(method);
                setTypedAttempt("");
                // speech input removed
            };

            // --- Handle spelling attempt (typed) ---
            const handleSpellingAttempt = async (attemptText) => {
                if (!currentWord) return;

                if (attemptText.trim() === "") {
                    setLastFeedback({ isCorrect: false, message: "I didn't catch any spelling. Try typing the letters!", attemptedWord: attemptText });
                    setGamePhase(GamePhase.DISPLAYING_FEEDBACK);
                    setIsProcessing(false);
                    return;
                }

                setIsProcessing(true);
                setGamePhase(GamePhase.PROCESSING_SPEECH);

                const feedback = await analyzeSpellingAttempt(currentWord.text, attemptText);

                let finalMessage = feedback.message;

                if (feedback.isCorrect) {
                    if (isCurrentWordRevealed) {
                        finalMessage = `Correct! The word was "${currentWord.text}". Good job checking the answer! No XP this time because it was revealed.`;
                        speakText(finalMessage);
                    } else {
                        finalMessage = feedback.message || `Great job! You spelled "${currentWord.text}" correctly!`;
                        speakText(finalMessage);
                        setUserProgress(prev => ({
                            ...prev,
                            xp: prev.xp + XP_PER_CORRECT_WORD,
                            correctlySpelledWords: [...prev.correctlySpelledWords, currentWord.id],
                        }));
                    }
                } else {
                    if (isCurrentWordRevealed) {
                        finalMessage = feedback.message.includes(currentWord.text) ? feedback.message : `Almost! The word was "${currentWord.text}". ${feedback.message}`;
                    } else {
                        finalMessage = feedback.message || `Oops! The word was "${currentWord.text}". Let's try again.`;
                    }
                    speakText(finalMessage);
                }

                setLastFeedback({ ...feedback, message: finalMessage });
                setIsProcessing(false);
                setGamePhase(GamePhase.DISPLAYING_FEEDBACK);
                setTypedAttempt("");
            };

            // --- Submit typed spelling attempt ---
            const handleSubmitTypedAttempt = () => {
                if (typedAttempt.trim()) {
                    handleSpellingAttempt(typedAttempt);
                } else {
                    setLastFeedback({ isCorrect: false, message: "Please type your spelling!", attemptedWord: "" });
                    setGamePhase(GamePhase.DISPLAYING_FEEDBACK);
                }
            };


            // --- Reveal the current word (no XP if revealed) ---
            const handleRevealWord = () => {
                if (currentWord) {
                    setIsCurrentWordRevealed(true);
                    speakText(`The word is: ${currentWord.text}.`);
                }
            };

            // --- Advance to next word after feedback ---
            const advanceToNextWordFromFeedback = () => {
                setCurrentWordIndex(prev => {
                    const next = prev + 1;
                    setUserProgress(p => ({ ...p, currentWordIndex: next }));
                    return next;
                });
                setTimeout(() => {
                    startNextWord();
                }, 100);
            };

            // --- EFFECT: Check and handle game phase changes ---
            React.useEffect(() => {
                if (gamePhase === GamePhase.LISTENING) {
                }
            }, [currentWordIndex, gamePhase]);

            // --- RENDER LOGIC ---

            // --- Render input controls for current input method ---
            const renderInputControls = () => {
                if (!currentWord || gamePhase === GamePhase.PRESENTING_WORD || gamePhase === GamePhase.PROCESSING_SPEECH || gamePhase === GamePhase.DISPLAYING_FEEDBACK) {
                    return null;
                }

                return (
                    <>

                        {currentInputMethod === InputMethod.TYPE && (
                            <div className="flex flex-col items-center w-full sm:w-auto">
                                <input
                                    type="text"
                                    value={typedAttempt}
                                    onChange={(e) => setTypedAttempt(e.target.value.toUpperCase())}
                                    placeholder="Type here..."
                                    aria-label="Type your spelling"
                                    disabled={isProcessing || isCurrentWordRevealed}
                                    className="px-4 py-3 mb-3 text-2xl border-2 border-blue-400 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full max-w-xs text-center uppercase tracking-widest disabled:bg-slate-100"
                                    onKeyPress={(e) => { if (e.key === 'Enter' && !isCurrentWordRevealed) handleSubmitTypedAttempt(); }}
                                />
                                <button
                                    onClick={handleSubmitTypedAttempt}
                                    disabled={isProcessing || typedAttempt.trim() === "" || isCurrentWordRevealed}
                                    className="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg shadow-md disabled:opacity-60 transform hover:scale-105 transition-transform focus:outline-none focus:ring-4 focus:ring-green-300"
                                >
                                    Submit Spelling
                                </button>
                            </div>
                        )}

                    </>
                );
            };

            // --- Render main content based on game phase ---
            const renderContent = () => {
                switch (gamePhase) {
                    case GamePhase.WELCOME:
                        return (
                            <div className="text-center p-6 bg-white/90 backdrop-blur-md rounded-2xl shadow-xl flex flex-col items-center">
                                <Avatar className="w-32 h-32 sm:w-40 sm:h-40 mb-4 text-blue-500" companionType={userProgress.companionType} />
                                <SparklesIcon className="w-16 h-16 text-amber-400 mx-auto mb-2 animate-pulse" />
                                <h1 className="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 via-teal-500 to-green-500 drop-shadow-lg mb-4">Spell & Learn Adventure!</h1>
                                <p className="text-lg sm:text-xl text-blue-700 mb-6">Get ready to spell words and earn awesome rewards!</p>
                                <button
                                    onClick={handleStartGame}
                                    className="px-8 py-4 bg-gradient-to-br from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white font-bold rounded-xl shadow-lg transform hover:scale-105 transition-transform text-xl sm:text-2xl flex items-center justify-center mx-auto ring-2 ring-orange-200 hover:ring-4"
                                >
                                    <PlayIcon className="w-7 h-7 sm:w-8 sm:h-8 mr-3" /> Start Spelling!
                                </button>
                            </div>
                        );

                    case GamePhase.PRESENTING_WORD:
                    case GamePhase.LISTENING:
                    case GamePhase.PROCESSING_SPEECH:
                    case GamePhase.DISPLAYING_FEEDBACK:
                        if (!currentWord) return <div className="flex justify-center items-center p-10"><LoaderIcon className="w-16 h-16 text-blue-500" /></div>;

                        let instructionText = "Your turn to spell:";
                        if (gamePhase === GamePhase.PRESENTING_WORD) instructionText = "Listen to the word...";
                        else if (gamePhase === GamePhase.LISTENING && currentInputMethod === InputMethod.TYPE) instructionText = "Type the word:";
                        else if (gamePhase === GamePhase.PROCESSING_SPEECH) instructionText = "Checking your amazing spelling...";

                        const showActualWord = isCurrentWordRevealed || gamePhase === GamePhase.PROCESSING_SPEECH || gamePhase === GamePhase.DISPLAYING_FEEDBACK;

                        return (
                            <div className="w-full max-w-2xl mx-auto">
                                <div className="mb-6 p-4 sm:p-8 bg-white/90 backdrop-blur-md rounded-2xl shadow-xl">
                                    <p className="text-blue-600 text-lg mb-2 text-center font-medium">{instructionText}</p>
                                    <h2 className="text-6xl sm:text-7xl font-bold text-blue-800 text-center my-6 sm:my-10 break-all tracking-widest select-none">
                                        {showActualWord ? currentWord.text : currentWord.text.split("").map(() => '\u00A0\u00A0?\u00A0\u00A0').join("")}
                                    </h2>

                                    <div className="flex justify-center items-center space-x-3 my-4">
                                        <button
                                            onClick={() => speakText(currentWord.text)}
                                            disabled={isProcessing || gamePhase === GamePhase.PRESENTING_WORD}
                                            className="p-3 bg-sky-500 hover:bg-sky-600 text-white rounded-full shadow-md disabled:opacity-60 disabled:cursor-not-allowed transform hover:scale-110 transition-all focus:outline-none focus:ring-4 focus:ring-sky-300"
                                            aria-label="Hear word again"
                                        >
                                            <SpeakerWaveIcon className="w-7 h-7" />
                                        </button>
                                        <button
                                            onClick={handleRevealWord}
                                            disabled={isCurrentWordRevealed || isProcessing}
                                            className="p-3 bg-yellow-400 hover:bg-yellow-500 text-white rounded-full shadow-md disabled:opacity-60 disabled:cursor-not-allowed transform hover:scale-110 transition-all focus:outline-none focus:ring-4 focus:ring-yellow-300"
                                            aria-label="Reveal word"
                                        >
                                            <EyeIcon className="w-7 h-7" />
                                        </button>
                                    </div>

                                    <div className="mt-4 mb-6 min-h-[100px] flex justify-center items-center">
                                        {renderInputControls()}
                                    </div>

                                    {isProcessing && (
                                        <div className="flex flex-col items-center justify-center">
                                            <LoaderIcon className="w-12 h-12 text-blue-500 mb-2" />
                                            <span className="text-blue-700 font-semibold">Checking your answer...</span>
                                        </div>
                                    )}

                                    {lastFeedback && gamePhase === GamePhase.DISPLAYING_FEEDBACK && (
                                        <div className={`my-4 p-5 rounded-lg text-center text-lg font-semibold transition-all duration-300 ease-in-out shadow-md
                          ${lastFeedback.isCorrect ? 'bg-green-100 border-2 border-green-500 text-green-700' : 'bg-red-100 border-2 border-red-500 text-red-700'} `}
                                        >
                                            <div className="flex items-center justify-center mb-2">
                                                {lastFeedback.isCorrect ? <CheckCircleIcon className="w-8 h-8 text-green-500 mr-2" /> : <XCircleIcon className="w-8 h-8 text-red-500 mr-2" />}
                                                <span>{lastFeedback.message}</span>
                                            </div>
                                            {lastFeedback.attemptedWord && !lastFeedback.isCorrect && (
                                                <div className="text-slate-600 text-base mt-2">You tried: <span className="font-mono text-lg">{lastFeedback.attemptedWord}</span></div>
                                            )}
                                        </div>
                                    )}

                                    {gamePhase === GamePhase.DISPLAYING_FEEDBACK && (
                                        <div className="flex justify-center mt-6">
                                            <button
                                                onClick={advanceToNextWordFromFeedback}
                                                className="px-8 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md transform hover:scale-105 transition-transform text-lg flex items-center focus:outline-none focus:ring-4 focus:ring-blue-300"
                                            >
                                                <ArrowPathIcon className="w-7 h-7 mr-2" /> Next Word
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {lastUnlockedReward && gamePhase === GamePhase.DISPLAYING_FEEDBACK && (
                                    <div className="mt-8 p-6 bg-yellow-100 border-2 border-yellow-400 rounded-xl shadow-lg flex flex-col items-center animate-bounce-slow">
                                        <div className="flex items-center mb-2">
                                            {lastUnlockedReward.type === 'sticker' && <StarIcon className="w-10 h-10 text-amber-500 mr-2" />}
                                            {lastUnlockedReward.type === 'badge' && <GiftIcon className="w-10 h-10 text-orange-500 mr-2" />}
                                            {lastUnlockedReward.type === 'companion' && <Avatar className="w-16 h-16 mr-2" companionType={lastUnlockedReward.companion} />}
                                            <span className="text-xl font-bold text-yellow-800">{lastUnlockedReward.name}</span>
                                        </div>
                                        <div className="text-yellow-700 text-lg">{lastUnlockedReward.description}</div>
                                    </div>
                                )}
                            </div>
                        );

                    case GamePhase.ALL_WORDS_COMPLETED:
                        return (
                            <div className="text-center p-6 bg-white/90 backdrop-blur-md rounded-2xl shadow-xl max-w-lg mx-auto flex flex-col items-center">
                                <Avatar className="w-32 h-32 mb-4" companionType={userProgress.companionType} />
                                <h2 className="text-3xl font-bold text-blue-700 mb-2">Congratulations!</h2>
                                <p className="text-lg text-blue-800 mb-4">You've completed all the words!</p>
                                <div className="flex flex-wrap justify-center gap-4 mb-4">
                                    {userProgress.unlockedRewards.map((reward, idx) => (
                                        <span key={idx} className="inline-flex items-center px-4 py-2 bg-yellow-200 text-yellow-900 rounded-lg font-semibold shadow">
                                            <StarIcon className="w-6 h-6 mr-2 text-amber-500" /> {reward}
                                        </span>
                                    ))}
                                </div>
                                <button
                                    onClick={handleStartGame}
                                    className="px-8 py-4 bg-gradient-to-br from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white font-bold rounded-xl shadow-lg transform hover:scale-105 transition-transform text-xl flex items-center justify-center mx-auto ring-2 ring-orange-200 hover:ring-4"
                                >
                                    <ArrowPathIcon className="w-7 h-7 mr-3" /> Play Again
                                </button>
                            </div>
                        );
                    default:
                        return <div className="flex items-center justify-center space-x-2 text-blue-600 p-10"><LoaderIcon className="w-10 h-10 text-blue-500" /><p className="text-lg">Loading your adventure...</p></div>;
                }
            };

            // --- Main render ---
            return (
                <div className="min-h-screen bg-gradient-to-br from-sky-500 via-cyan-400 to-emerald-500 flex flex-col items-center justify-center p-2 sm:p-4 selection:bg-yellow-300 selection:text-yellow-800">
                    <style>{`
                .animate-bounce-slow {
                  animation: bounce-slow 2s infinite;
                }
                @keyframes bounce-slow {
                  0%, 100% { transform: translateY(0); }
                  50% { transform: translateY(-12px); }
                }
                .touch-none { touch-action: none; }
              `}</style>
                    <header className="w-full max-w-2xl mx-auto mb-4 sm:mb-8 p-3 sm:p-4 bg-white/80 backdrop-blur-md rounded-xl shadow-lg flex justify-between items-center">
                        <div className="flex items-center space-x-3">
                            <Avatar className="w-12 h-12" companionType={userProgress.companionType} />
                            <span className="text-lg font-bold text-blue-700">XP: {userProgress.xp}</span>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button
                                onClick={() => handleChangeInputMethod(InputMethod.TYPE)}
                                className={`p-2 rounded-full ${currentInputMethod === InputMethod.TYPE ? 'bg-blue-500 text-white' : 'bg-slate-200 text-blue-700'} hover:bg-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-300`}
                                aria-label="Use keyboard input"
                            >
                                <KeyboardIcon className="w-6 h-6" />
                            </button>
                        </div>
                    </header>
                    <main className="w-full flex-1 flex flex-col items-center justify-center">
                        {renderContent()}
                    </main>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>

</html>